# Podfile for BarqNet iOS

# Specify the Xcode project explicitly
project 'WorkVPN.xcodeproj'

platform :ios, '15.0'
use_frameworks!

# Main app target
target 'WorkVPN' do
  # OpenVPN library for real VPN functionality
  # NOTE: Repository archived March 2022, but stable and working
  # See TECHNICAL_DEBT.md for decision rationale and migration plan
  # Version: 0.8.0 | Last reviewed: November 2025
  pod 'OpenVPNAdapter', :git => 'https://github.com/ss-abramchuk/OpenVPNAdapter.git', :branch => 'master'
end

# Network Extension target
target 'WorkVPNTunnelExtension' do
  # OpenVPN library (required in extension too)
  # Same version as main app target
  pod 'OpenVPNAdapter', :git => 'https://github.com/ss-abramchuk/OpenVPNAdapter.git', :branch => 'master'
end

# Post install hooks
post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
      config.build_settings['ENABLE_BITCODE'] = 'NO'
    end
  end

  # Xcode 16 Fix: Modify framework embedding to use cp instead of rsync for Simulator
  # This prevents sandbox errors while still making the framework available
  frameworks_script_path = 'Pods/Target Support Files/Pods-WorkVPN/Pods-WorkVPN-frameworks.sh'
  if File.exist?(frameworks_script_path)
    frameworks_script = File.read(frameworks_script_path)

    # Check if already patched
    unless frameworks_script.include?('# Xcode 16 Fix')
      puts "Patching #{frameworks_script_path} for Xcode 16 Simulator compatibility..."

      # Inject Simulator fix right after destination is set, before rsync
      patched_script = frameworks_script.gsub(
        '  local destination="${TARGET_BUILD_DIR}/${FRAMEWORKS_FOLDER_PATH}"',
        '  local destination="${TARGET_BUILD_DIR}/${FRAMEWORKS_FOLDER_PATH}"

  # Xcode 16 Fix: Use cp instead of rsync for Simulator to avoid sandbox errors
  if [[ "${EFFECTIVE_PLATFORM_NAME}" == "-iphonesimulator" ]]; then
    echo "Copying ${source} to ${destination} (Simulator - using cp)"
    mkdir -p "${destination}"
    cp -R "${source}" "${destination}/"
    # Get basename for code signing
    local basename
    basename="$(basename -s .framework "$1")"
    code_sign_if_enabled "${destination}/$(basename "$1")"
    return 0
  fi'
      )

      File.write(frameworks_script_path, patched_script)
      puts "âœ“ Successfully patched frameworks script for Xcode 16"
    end
  end
end
